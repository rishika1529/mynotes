<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MyNotes - Write Notes</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@700&family=Indie+Flower&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(120deg, #ffeef6 0%, #d0f1ff 100%);
      font-family: 'Indie Flower', 'Quicksand', cursive, sans-serif;
      margin: 0;
      min-height: 100vh;
      color: #a259c6;
      position: relative;
      overflow-x: hidden;
    }
    .dashboard-link {
      position: fixed;
      top: 28px;
      right: 40px;
      z-index: 100;
      background: #ffb6d5;
      color: #fff;
      font-family: 'Quicksand', sans-serif;
      font-weight: bold;
      font-size: 1.1rem;
      border-radius: 20px;
      padding: 10px 26px;
      text-decoration: none;
      box-shadow: 0 2px 8px #ffe0ec;
      letter-spacing: 1px;
      transition: background 0.2s, transform 0.1s;
      border: 2px solid #fff0f7;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .dashboard-link:hover {
      background: #ff7eb9;
      transform: scale(1.05);
    }
    .canvas-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 90px;
      min-height: 60vh;
    }
    .note-canvas-main {
      background: #fff7fb;
      border-radius: 32px;
      box-shadow: 0 8px 32px #f9b4d1a0;
      padding: 36px 28px 28px 28px;
      min-width: 600px;
      max-width: 900px;
      min-height: 400px;
      width: 90vw;
      max-height: 80vh;
      border: 2.5px dashed #ffb6d5;
      display: flex;
      flex-direction: column;
      position: relative;
      margin-bottom: 30px;
      transition: box-shadow 0.2s, transform 0.1s;
      animation: popIn 0.4s;
    }
    .note-canvas-main textarea {
      border: none;
      background: transparent;
      resize: none;
      font-family: 'Indie Flower', cursive;
      font-size: 1.5rem;
      color: #a259c6;
      outline: none;
      min-height: 300px;
      max-height: 600px;
      width: 100%;
      padding: 0;
      margin-bottom: 10px;
      transition: background 0.2s;
    }
    .note-canvas-main .note-date {
      font-size: 1.05rem;
      color: #b48bc6;
      text-align: right;
      margin-top: auto;
      margin-bottom: 2px;
      font-family: 'Quicksand', sans-serif;
    }
    .note-canvas-main .delete-btn {
      position: absolute;
      top: 14px;
      right: 18px;
      background: #ffb6d5;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      font-size: 1.5rem;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      box-shadow: 0 2px 8px #ffe0ec;
      z-index: 2;
    }
    .note-canvas-main .delete-btn:hover {
      background: #ff7eb9;
      transform: scale(1.1) rotate(-10deg);
    }
    .floating-add-btn {
      position: fixed;
      bottom: 38px;
      right: 38px;
      background: linear-gradient(90deg, #ffb6d5 60%, #ff7eb9 100%);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 70px;
      height: 70px;
      font-size: 2.5rem;
      font-family: inherit;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 16px #ffe0ec;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, transform 0.1s;
      z-index: 200;
    }
    .floating-add-btn:hover {
      background: linear-gradient(90deg, #ff7eb9 0%, #ffb6d5 100%);
      transform: scale(1.08) rotate(8deg);
    }
    .notes-list {
      margin-top: 18px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      align-items: center;
      width: 100%;
      max-width: 900px;
    }
    .note-canvas {
      background: #fff7fb;
      border-radius: 24px;
      box-shadow: 0 4px 16px #f9b4d1a0;
      padding: 28px 24px 18px 24px;
      min-width: 500px;
      max-width: 850px;
      min-height: 180px;
      border: 2px dashed #b5baff;
      position: relative;
      display: flex;
      flex-direction: column;
      transition: box-shadow 0.2s, transform 0.1s;
      animation: popIn 0.4s;
    }
    .note-canvas textarea {
      border: none;
      background: transparent;
      resize: none;
      font-family: 'Indie Flower', cursive;
      font-size: 1.3rem;
      color: #a259c6;
      outline: none;
      min-height: 100px;
      max-height: 400px;
      width: 100%;
      padding: 0;
      margin-bottom: 8px;
    }
    .note-canvas .note-date {
      font-size: 1rem;
      color: #b48bc6;
      text-align: right;
      margin-top: auto;
      margin-bottom: 2px;
      font-family: 'Quicksand', sans-serif;
    }
    .note-canvas .delete-btn {
      position: absolute;
      top: 10px;
      right: 12px;
      background: #b5baff;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 1.3rem;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      box-shadow: 0 2px 8px #e0f7fa;
    }
    .note-canvas .delete-btn:hover {
      background: #a259c6;
      transform: scale(1.1) rotate(-10deg);
    }
    .empty-msg {
      color: #bdbdbd;
      font-size: 1.2rem;
      margin-top: 40px;
      font-family: 'Quicksand', sans-serif;
      text-align: center;
      width: 100%;
    }
    @keyframes popIn {
      0% { transform: scale(0.95); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    @media (max-width: 1000px) {
      .note-canvas-main, .note-canvas, .notes-list {
        min-width: 95vw;
        max-width: 98vw;
      }
    }
    @media (max-width: 700px) {
      .canvas-container, .notes-list {
        max-width: 98vw;
      }
      .note-canvas-main, .note-canvas {
        min-width: 95vw;
        max-width: 98vw;
      }
      .dashboard-link {
        right: 10px;
        top: 10px;
        padding: 8px 16px;
        font-size: 1rem;
      }
      .floating-add-btn {
        right: 12px;
        bottom: 16px;
      }
    }
  </style>
</head>
<body>
<a href="home.html" class="dashboard-link">üè† Dashboard</a>
  <div class="canvas-container">
    <div class="note-canvas-main">
      <button class="delete-btn" title="Clear" onclick="clearMainNote()">&times;</button>
      <textarea id="mainNote" placeholder="Write your notes here..."></textarea>
      <div class="note-date" id="mainNoteDate"></div>
      <input type="email" id="shareEmail" placeholder="Share with email" style="margin-top: 10px; font-family: 'Quicksand';">
      <button onclick="shareNote()" style="margin-top: 5px; font-family: 'Quicksand';">Share Note</button>
    </div>
    <div class="notes-list" id="notesList"></div>
    <div class="empty-msg" id="emptyMsg" style="display:none;">No saved notes yet. Click the pink + button to save your first note! üíñ</div>
  </div>
  <button class="floating-add-btn" onclick="addNote()" title="Save as new note">+</button>
  <script>
      const mainNote = document.getElementById('mainNote');
    const mainNoteDate = document.getElementById('mainNoteDate');
    const SERVER_URL = 'http://localhost:3000/api/notes'; // Your Node.js server URL
    let currentUserEmail = ''; // To store the email of the logged-in user

    // Function to get current user email from sessionStorage
    function getUserEmail() {
      return sessionStorage.getItem('userEmail');
    }

    // Initialize user email on page load
    document.addEventListener('DOMContentLoaded', () => {
      currentUserEmail = getUserEmail();
      if (!currentUserEmail) {
        alert('Please log in from the dashboard to manage your notes.');
        window.location.href = 'home.html'; // Redirect if no user email
      } else {
        renderNotes(); // Load notes for the logged-in user
      }
    });

    // Fetches notes from the backend for the current user
    async function getNotesFromBackend() {
      try {
        const response = await fetch(`${SERVER_URL}?email=${currentUserEmail}`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const notes = await response.json();
        return notes;
      } catch (error) {
        console.error('Error fetching notes:', error);
        alert('Failed to load notes. Please try again later.');
        return [];
      }
    }

    // Renders notes fetched from the backend
    async function renderNotes() {
      const notes = await getNotesFromBackend();
      const notesList = document.getElementById('notesList');
      const emptyMsg = document.getElementById('emptyMsg');
      notesList.innerHTML = ''; // Clear existing notes

      if (notes.length === 0) {
        emptyMsg.style.display = '';
      } else {
        emptyMsg.style.display = 'none';
        notes.forEach(note => { // Use 'note' directly, no need for idx since we use _id for operations
          const div = document.createElement('div');
          div.className = 'note-canvas';
          // Store note._id as a data attribute for easy access
          div.setAttribute('data-id', note._id);
          div.innerHTML = `
            <button class="delete-btn" title="Delete" onclick="deleteNote('${note._id}')">&times;</button>
            <textarea oninput="editNote('${note._id}', this.value)">${note.text}</textarea>
            <div class="note-date">${note.date || ''}</div>
            ${note.userEmail === currentUserEmail ? `<button onclick="showShareInput(this, '${note._id}')" style="margin-top: 5px; font-family: 'Quicksand';">Share Note</button>` : ''}
            <input type="email" class="share-input" placeholder="Share with email" style="display:none; margin-top: 10px; font-family: 'Quicksand';">
            <button class="send-share-btn" style="display:none; margin-top: 5px; font-family: 'Quicksand';" onclick="shareNote(this, '${note._id}')">Send Share</button>
          `;
          notesList.appendChild(div);
        });
      }
    }

    function showShareInput(button, noteId) {
        const noteCanvas = button.closest('.note-canvas');
        const shareInput = noteCanvas.querySelector('.share-input');
        const sendShareBtn = noteCanvas.querySelector('.send-share-btn');
        if (shareInput && sendShareBtn) {
            shareInput.style.display = 'block';
            sendShareBtn.style.display = 'block';
            button.style.display = 'none'; // Hide the initial share button
        }
    }

    // Adds a new note to the backend
    async function addNote() {
      const text = mainNote.value.trim();
      if (!text) {
        mainNote.focus();
        return;
      }

      const noteData = {
        text: text,
        user: { email: currentUserEmail }, // Pass user email
        sharedWith: []
      };

      try {
        const response = await fetch(SERVER_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(noteData),
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const newNote = await response.json();
        console.log('Note added:', newNote);
        mainNote.value = '';
        mainNoteDate.textContent = '';
        renderNotes(); // Re-render notes to show the new one
      } catch (error) {
        console.error('Error adding note:', error);
        alert('Failed to add note. Please try again.');
      }
    }

    // Edits an existing note on the backend
    async function editNote(id, value) {
      try {
        const response = await fetch(`${SERVER_URL}/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ text: value, requestingUserEmail: currentUserEmail }), // Pass requesting user email for authorization
        });

        if (!response.ok) {
          // If the server returns an error, log it and potentially revert the UI
          const errorData = await response.json();
          console.error('Error updating note:', errorData.error || response.statusText);
          alert('Failed to update note: ' + (errorData.error || 'Permission denied or network issue.'));
          renderNotes(); // Re-render to revert any local changes if update failed
        } else {
          console.log('Note updated successfully');
        }
      } catch (error) {
        console.error('Error editing note:', error);
        alert('Failed to update note. Please check your connection.');
        renderNotes(); // Re-render to revert any local changes if update failed
      }
    }

    // Deletes a note from the backend
    async function deleteNote(id) {
      if (!confirm('Are you sure you want to delete this note?')) {
        return;
      }
      try {
        const response = await fetch(`${SERVER_URL}/${id}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ requestingUserEmail: currentUserEmail }), // Pass requesting user email for authorization
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
        }

        console.log('Note deleted:', id);
        renderNotes(); // Re-render notes after deletion
      } catch (error) {
        console.error('Error deleting note:', error);
        alert('Failed to delete note: ' + error.message);
      }
    }

    // Shares a note with another user via backend
    async function shareNote(button, noteId) {
        const noteCanvas = button.closest('.note-canvas');
        const shareInput = noteCanvas.querySelector('.share-input');
        const emailToShareWith = shareInput.value.trim();

        if (!emailToShareWith) {
            alert('Please enter an email to share with.');
            return;
        }

        try {
            const response = await fetch(`${SERVER_URL}/${noteId}/share`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ emailToShareWith, requestingUserEmail: currentUserEmail }),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
            }

            alert(`Note shared successfully with ${emailToShareWith}`);
            shareInput.value = ''; // Clear input
            shareInput.style.display = 'none'; // Hide input
            button.style.display = 'none'; // Hide send button
            noteCanvas.querySelector('button[onclick^="showShareInput"]').style.display = 'block'; // Show original share button

        } catch (error) {
            console.error('Error sharing note:', error);
            alert('Failed to share note: ' + error.message);
        }
    }

    function clearMainNote() {
      mainNote.value = '';
      mainNoteDate.textContent = '';
      mainNote.focus();
    }

    // Optional: Show last edit time for main note (now just for local display)
    mainNote.addEventListener('input', () => {
      const now = new Date();
      mainNoteDate.textContent = 'Last edit: ' + now.toLocaleTimeString();
    });

  </script>
</body>
</html>